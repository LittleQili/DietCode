name: RTX 2080 Ti server

on:
  schedule:
    - cron: "0 9 * * *"

jobs:
  build:
    runs-on: eco-cluster
    steps:
      - uses: actions/checkout@master
        with:
          submodules: recursive
      - name: DietCode (build)
        run: docker-compose run --rm -e NVIDIA_VISIBLE_DEVICES=3 tvm-dev bash -c "/mnt/scripts/1-build.sh tvm"
      - name: Base (Build)
        run: docker-compose run --rm -e NVIDIA_VISIBLE_DEVICES=3 tvm-dev bash -c "/mnt/scripts/1-build.sh tvm_base"
      - name: Code Generation Tests
        run: docker-compose run --rm -e NVIDIA_VISIBLE_DEVICES=3 -w /mnt/tests/ tvm-dev bash -c "source ../environ/activate_dietcode.sh && python3 -m pytest codegen"
      - name: Cleanup
        if: always()
        run: docker-compose run --rm tvm-dev bash -c "chown -R \$(stat -c '%u:%g' /mnt) /mnt"
