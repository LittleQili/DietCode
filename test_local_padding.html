
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Local Padding &#8212; DietCode MLSys 2022 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxdoc.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="DietCode Documentation (Test Cases)" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="index.html" title="DietCode Documentation (Test Cases)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">DietCode MLSys 2022 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Local Padding</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="module-codegen.test_local_padding">
<span id="local-padding"></span><h1>Local Padding<a class="headerlink" href="#module-codegen.test_local_padding" title="Permalink to this headline">¶</a></h1>
<dl class="py function">
<dt class="sig sig-object py" id="codegen.test_local_padding.test_local_padding">
<span class="sig-prename descclassname"><span class="pre">codegen.test_local_padding.</span></span><span class="sig-name descname"><span class="pre">test_local_padding</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#codegen.test_local_padding.test_local_padding" title="Permalink to this definition">¶</a></dt>
<dd><p>This test case shows the performance improvement brought by local padding.
We compare the compute throughputs between two schedules, one without local
padding (baseline) and the other with local padding (DietCode).</p>
<p>We use the dense layer as the workload:</p>
<blockquote>
<div><p>Mathematical Expression: Y = XW^T, X : [B × T, I], W : [H, I], Y : [B ×
T, H]</p>
<dl class="simple">
<dt>for (i = 0; i &lt; B × T; ++i)</dt><dd><dl class="simple">
<dt>for (j = 0: j &lt; H; ++j)</dt><dd><dl class="simple">
<dt>for (k = 0; k &lt; I; ++k)</dt><dd><p>Y[i, j] += X[i, k] * W[j, k]</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>where (B, T, I, H) stand for (batch size, sequence length, input size,
hidden dimension) respectively (namings adopted from the BERT model).</p>
<p>We adopt a sample schedule <cite>dense_128x128x4</cite> for this workload. The
schedule, as its name suggests, has a tile size of (128, 128, 4) along the
(i, j, k) dimension respectively.</p>
<p>Furthermore, we deliberately set the value of the sequence length T to 60,
and the input size I to 770, so that</p>
<blockquote>
<div><p>(B * T = 16 * 60 = 960) % 128 ≠ 0</p>
<p>(I = 770) % 4 ≠ 0</p>
</div></blockquote>
<p>which is common in the case of handling dynamic-shape workloads.</p>
<p>Due to the imperfect tiling, predicates have to be injected inside the loop
body, which can greatly hurt the performance. However, we make the following
key observations:</p>
<ul class="simple">
<li><p>The schedule generated by the auto-scheduler usually consists of 3 main
stages, namely</p>
<ul>
<li><p>Fetch: Obtain the input data from the global to the shared memory.</p></li>
<li><p>Compute: Compute output results using the shared memory variables and
write to the local registers.</p></li>
<li><p>Writeback: Write the results of the local registers back to the global
memory.</p></li>
</ul>
</li>
<li><p>The predicates at the <em>Compute</em> stage have the biggest impact on the
runtime performance, but the good news is they duplicate those at the
Fetch and the Writeback stage and hence can be safely removed. This is in
essence padding the compute by the size of the local workspace, hence the
name <em>local padding</em>.</p></li>
</ul>
<p>Our evaluations show that the local padding optimization of DietCode can
significantly boost the performance of the generated CUDA kernel by more
than 10× in this case (on a modern NVIDIA RTX 3090 GPU).</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="codegen.test_local_padding.test_local_padding_ii">
<span class="sig-prename descclassname"><span class="pre">codegen.test_local_padding.</span></span><span class="sig-name descname"><span class="pre">test_local_padding_ii</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#codegen.test_local_padding.test_local_padding_ii" title="Permalink to this definition">¶</a></dt>
<dd><p>This test case shows the necessity of NOT shrinking the local workspace,
which is required for local padding.</p>
<p>In TVM, the size of the local workspace (e.g., shared memory or registers)
will be automatically shrinked if the code generator detects that the
workspace is not fully utilized by the tensor programs. However, this
optimization can be NOT desirable.</p>
<p>For example, consider the batched matrix multiply workload:</p>
<blockquote>
<div><p>Mathematical Expression: C = AB^T, A : [B, T, H / NH], B : [B, T, H /
NH], C : [B, T, T]</p>
<dl class="simple">
<dt>for (i = 0; i &lt; B; ++i)</dt><dd><dl class="simple">
<dt>for (j = 0: j &lt; T; ++j)</dt><dd><dl class="simple">
<dt>for (k = 0; k &lt; T; ++k)</dt><dd><dl class="simple">
<dt>for (l = 0; l &lt; H / NH; ++l)</dt><dd><p>C[i, j, k] += A[i, j, l] * B[i, k, l]</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>where NH stands for the number of attention heads (also adopted from the
BERT model, other parameters are the same as above).</p>
<p>We adopt a sample schedule <cite>batch_matmul_nt_1x128x128x8</cite> for this workload.
The schedule has a tile size of (1, 128, 128, 8) along the (i, j, k, l)
dimension respectively. By the tile sizes, the local workspace (i.e., shared
memory allocations) for A and B are 1×128×8 and 1×128×8 respectively.</p>
<p>This works fine in the case when T=128, but if T is just a little smaller
(e.g., T=120), the TVM code generator will find out that all the thread
blocks are not fully utilizing the shared memory variables and shrink them,
which prevents local padding from taking place.</p>
</dd></dl>

</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="index.html"
                          title="previous chapter">DietCode Documentation (Test Cases)</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/test_local_padding.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="index.html" title="DietCode Documentation (Test Cases)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">DietCode MLSys 2022 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Local Padding</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, University of Toronto, AWS, Vector Institute.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>